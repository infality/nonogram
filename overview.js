const gameData = "20;10;AAAAAAAAAAAAAAAAAABX/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///597/+IgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABz//8///////AAAAAAAAAjKAAAA4AAAAAAAAAAAAAAAAAAAAAAT/7/g//////4AAABf+AAAAAAAADeAAAAAAAAAAAAAAAAAAAAGHs//8///////gAAAD+gAAAAAAAAAA8AAAAAAAAAAAAAAAAAADIIBBvgF//////gAAAA4QAAAAAAAAAAcAAAAAAAAAAAAAAAAAA6jF55hAP//////IAAAAAAAAAAA4AAAB/8AAAAAAAAAAAAAAAAAB307f+AAA/////8AAAAAAAAAD4AAAf//8AAA/nAAAAAAAAAAAB+AAB4AAAAf////gAAAAAAAAAHAAAA///oAABAAAAAAAAAAAAAD/6wbzf4AAH///7AAAAAAAAAAOADAP//////AAAAAAAAAAAAAAB3/4bH/+AAL////AAAAAAAAAAcAHb///////IH+AAAAAAD/wAAQAH+Dj//4AH///QAAAAAAfwAAAAPv7//////////gAAAAP//8f/x/+MwYH8AE///8AAAAAL/8ACAHHv////////////z+wA///////AYN88J+AD//6AAAAAAP//4Y///v//////////////9AP///////f//8A/gH//wAAAAAA///+T///P//////////////fx//////j////AD8wD/9ADfAAAB//+D///////////////////BB7/////////+8f+AB/wAB/AAAD/H+b//////////////////6AQD/////////5SA/AB/wAAYAAAf+f////////////////////+AA///////7//gIaGAAfgAAAAAB/w///////////////////9/4AA//f///9f//AAfgAAPgAAAAAC/w/n////////////////+Z/AABf+w//////+AAfwAABAAAAAAB/6Qf////////////////4HAAAAH8AB/////+AA/xgAAAAAAAEB24v///////////////8AweAAAAAaAAf/////gAP/4AAAAAAAYAD0P///////////////4AB8AAAABgAAP/////8AP/wAAAAAAAcAZw////////////////gAD8AAAAEAAAH//////gf/8AAAAAAAeARA////////////v///AAD4AAAAAAAAA////3/4//+AAAAAAD/Aaf////////////f///oADwAAAEAAAAAf///3/8///wAAAAABnB/////////////+f///+ADgAAQAAAAAAP///3/+f//wAAAAADPj/////////////9////+ABAAAAAAAAAAX///7////+gAAAAAAPP//////////////////5ACAAAAAAAAAAF///////8QwAAAAAAA///////////////////5AAAAAAAAAAAAA////9//3h8AAAAAAP///////////////////6AAAAAAAAAAAAB////yP/vAEAAAAAAD///////////////////yAAAAAAAAAAAAB/////3//0AAAAAAAB////3P+H///////////iBAAAAAAAAAAAB////+5/8wAAAAAAAB/8//jf4fj/////////3CEAAAAAAAAAAAB////+zHxAAAAAAAAB/mf/AH8f//////////+D4AAAAAAAAAAAD////++/gAAAAAAAB/4HH+AB8P//////////wHAAAAAAAAAAAAB/////7/gAAAAAAAB/wBj/HB+H//////////AAAAAAAAAAAAAAB//////8AAAAAAAAB/gQTz//+P////////++AEAAAAAAAAAAAAB//////wAAAAAAAAD/AQRj//+H////////4EAGAAAAAAAAAAAAA//////wAAAAAAAAB/ABw5//+H////////4OAcAAAAAAAAAAAAA//////wAAAAAAAAAeB4gg///H/////////DAcAAAAAAAAAAAAAf/////4AAAAAAAAAR/4AAA///////////8DA8AAAAAAAAAAAAAP/////wAAAAAAAAAf/4AAA///////////8ENgAAAAAAAAAAAAAD/////AAAAAAAAAA//4AAB///////////+AcAAAAAAAAAAAAAAB////+AAAAAAAAAB///hgB///////////+AwAAAAAAAAAAAAAABv///8AAAAAAAAAD///x/b////////////AAAAAAAAAAAAAAAAAv//8cAAAAAAAAAD///////+/////////+AAAAAAAAAAAAAAAAAf/+AGAAAAAAAAAH/////7/8f////////+AAAAAAAAAAAAAAAAAb/4AGAAAAAAAAAf/////8/+P////////+AAAAAAAAAAAAAAAAAJ/4ACAAAAAAAAA//////8//E////////8AAAAAAAAAAAAAAAAAF/4ACAAAAAAAAA//////+f/iG///////4AAAAAAAAAAAAAAAAAAf4AAAAAAAAAAB///////P/vAP//////yAAAAAAAAAAAAAAAAACP4AGAAAAAAAAB///////P//gH//////iAAAAAAAAAAAAAAAAAAP4ABgAAAAAAAD///////n//wD//5//8AAAAAAAAAAAAAAAAAAAP4HAMAAAAAAAD///////n//gAf/h/+AAAAAAAAAAAAAIAAAAAAH8OABwAAAAAAD///////j//AAf+A/8QAAAAAAAAAAAAAAAAAAAD++ATyAAAAAAB///////x/+AAf8Af8QAAAAAAAAAAAAAAAAAAAA/+AAAAAAAAAB///////5/8AAf4Af+ADAAAAAAAAAAAAAAAAAAAO8AAAAAAAAAD///////4/wAAfwAX/ADAAAAAAAAAAAAAAAAAAAAf4AAAAAAACD///////8/AAAPgAD/gCAAAAAAAAAAAAAAAAAAAAH4AAAAAAAAD///+///+8AAAPgAD/gAgAAAAAAAAAAAAAAAAAAABwAAAAAAAAD////////AAAAHgBCfgAQAAAAAAAAAAAAAAAAAAAAwBIAAAAAAB////////BgAAHgACPgAoAAAAAAAAAAAAAAAAAAAAYHewAAAAAA/////////gAAHgACGAEgAAAAAAAAAAAAAAAAAAAANnf4AAAAAAf////////AAACQACEAIAAAAAAQAAAAAAAAAAAAAACf/+AAAAAAf////////AAAAwABAAA4AAAAAAAAAAAAAAAAAAAAAf//AAAAAAH///////+AAAAQABgAAYAAAAAAAAAAAAAAAAAAAAAP//4AAAAAD/D/////+AAAAAAAwAYAAAAAAAAAAAAAAAAAAAAAAP//+AAAAABABf////8AAAAAAMwB4AAAAAAAAAAAAAAAAAAAAAAP///AAAAAAAAP////4AAAAAAGwDwAAAAAAAAAAAAAAAAAAAAAAf///AAAAAAAAP////wAAAAAADYHwAAAAAAAAAAAAAAAAAAAAAA////AAAAAAAAP////gAAAAAAFwfxSAAAAAAAAAAAAAAAAAAAAB////AAAAAAAAP//7/AAAAAAABwfwAAAAAAAAAAAAAAAAAAAAAB////8AAAAAAAP//7+AAAAAAAC4PzgcAAAAAAAAAAAAAAAAAAAA////+AAAAAAAP//78AAAAAAAA+PnAE4BAAAAAAAAAAAAAAAAAB/////8AAAAAAH///4AAAAAAAAcAhED/AAAAAAAAAAAAAAAAAAD/////+AAAAAAD//f4AAAAAAAAMABgA/wAAAAAAAAAAAAAAAAAD//////gAAAAAD///4AAAAAAAADAAAAf7EAAAAAAAAAAAAAAAAA//////gAAAAAB//v4AAAAAAAAB+AAAP4AAAAAAAAAAAAAAAAAA//////gAAAAAB///4AAAAAAAAAGKwAXMBAAAAAAAAAAAAAAAAAf/////gAAAAAB///4AAAAAAAAAAEQAAGAYAAAAAAAAAAAAAAAAf/////AAAAAAB///8AAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAP////+AAAAAAB///8AAAAAAAAAAAAoCAAAAAAAAAAAAAAAAAAAP////8AAAAAAB///8BAAAAAAAAAAA/DAAAAAAAAAAAAAAAAAAAP////8AAAAAAD///8DAAAAAAAAAAA+DAAAAAAAAAAAAAAAAAAAH////8AAAAAAD///8HAAAAAAAAAAP+DgAAAAAAAAAAAAAAAAAAB////8AAAAAAD///4fAAAAAAAAAAP/jgAAQBAAAAQAAAAAAAAAAf///4AAAAAAD///geAAAAAAAAAA//3wAAACAAAAAAAAAAAAAAAf///4AAAAAAD///AeAAAAAAAAAB///wAAAAAAAAAAAAAAAAAAAP///4AAAAAAB//+AeAAAAAAAAAD///4AAAAAAAAAAAAAAAAAAAP///wAAAAAAB//+AcAAAAAAAAAf///8ABAAAAAAAAAAAAAAAAAP///wAAAAAAA///A8AAAAAAAAB////+AAgAAAAAAAAAAAAAAAAf//+AAAAAAAA///A8AAAAAAAAB/////AAAAAAAAAAAAAAAAAAAf//4AAAAAAAA//+A4AAAAAAAAD/////gAAAAAAAAAAAAAAAAAAf//wAAAAAAAA//4AAAAAAAAAAB/////gAAAAAAAAAAAAAAAAAAf//wAAAAAAAAf/4AAAAAAAAAAB/////wAAAAAAAAAAAAAAAAAAf//wAAAAAAAAf/4AAAAAAAAAAB/////wAAAAAAAAAAAAAAAAAA///gAAAAAAAAP/wAAAAAAAAAAA/////wAAAAAAAAAAAAAAAAAA///AAAAAAAAAP/wAAAAAAAAAAA/////wAAAAAAAAAAAAAAAAAA///AAAAAAAAAH/gAAAAAAAAAAA/////wAAAAAAAAAAAAAAAAAA//8AAAAAAAAAH/AAAAAAAAAAAA/wD//gAAAAAAAAAAAAAAAAAA//8AAAAAAAAAH8AAAAAAAAAAAA/gBf/AAAAAAAAAAAAAAAAAAA//AAAAAAAAAAAAAAAAAAAAAAAAYAA//AAAgAAAAAAAAAAAAAAB//AAAAAAAAAAAAAAAAAAAAAAAAAAAP+AAAQAAAAAAAAAAAAAAB//gAAAAAAAAAAAAAAAAAAAAAAAAAAH+AAAIAAAAAAAAAAAAAAB//AAAAAAAAAAAAAAAAAAAAAAAAAAABYAAAOAAAAAAAAAAAAAAB/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAAAAAAAAB/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAABgAAAAAAAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAADAAAAAAAAAAAAAAAB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAAAAAAAAAAAAH8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAD+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8AAAAAAAAAAAAAAAcAAAIwP8OBQ+AAAAAAAAAAAAAAAAAAAAAD8AAAAAAAAAAAAAAD/gAAP////////gAAAAAAAAAAAAAAAAAAAD4AAAAAAAAAAAAAB///+h//////////4AAAAAAAAAAAAAAAAAF38AAAAAAABgBgA/v////////////////gAAAAAAAAAAAAAAAAH/8AAAAAAD////////////////////////gAAAAAAAAAAAAkAAD/8AAAAAA/////////////////////////8AAAAAAAAAAAD///+/+AAAAAP/////////////////////////4AAAAAAAB//0Z/////8AAAAB//////////////////////////gAAAAAC///////////+AAAAP/////////////////////////+AAAAAAf////////////gAAB//////////////////////////8AAAAA//////////////54Qf//////////////////////////9/g////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////";

let gameRows = 10;
let gameCols = 15;

let game = parseGameString(gameData);
loadOverview();

function loadOverview() {
    let overViewDiv = document.createElement("div");
    overViewDiv.id = "overview";
    document.body.appendChild(overViewDiv);

    let headerDiv = document.createElement("div");
    headerDiv.id = "header";
    overViewDiv.appendChild(headerDiv);

    let progressDiv = document.createElement("div");
    progressDiv.id = "progress";
    headerDiv.appendChild(progressDiv);

    let progressBar = document.createElement("div");
    progressBar.id = "progressBar";
    progressBar.style.width = "25%";
    progressDiv.appendChild(progressBar);

    let progressInfo = document.createElement("div");
    progressInfo.id = "progressInfo";
    progressInfo.innerHTML = "25%";
    progressDiv.appendChild(progressInfo);

    let gamePreviewsDiv = document.createElement("div");
    gamePreviewsDiv.id = "gamePreviews";
    overViewDiv.appendChild(gamePreviewsDiv);

    const stylesheet = document.styleSheets[0];
    for (let i = 0; i < stylesheet.cssRules.length; i++) {
        if (stylesheet.cssRules[i].selectorText == '.gamePreview') {
            let size = `min(${80 / gameCols}vw,${70 / gameRows}vh)`;
            stylesheet.cssRules[i].style.width = size;
            stylesheet.cssRules[i].style.height = size;
            break;
        }
    }

    for (let row = 0; row < gameRows; row++) {
        let gamePreviewRow = document.createElement("div");
        gamePreviewRow.classList.add("gamePreviewRow");
        gamePreviewsDiv.appendChild(gamePreviewRow);

        for (let col = 0; col < gameCols; col++) {
            let gamePreviewDiv = document.createElement("div");
            gamePreviewDiv.classList.add("gamePreview");
            gamePreviewDiv.addEventListener("click", _ => {
                clickedPreview(row, col);
            });
            gamePreviewRow.appendChild(gamePreviewDiv);

            if (Math.random() < 0.75) {
                //continue;
            }
            let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", `0,0,${dimensionSize},${dimensionSize}`);
            gamePreviewDiv.appendChild(svg);

            for (let tileRow = 0; tileRow < dimensionSize; tileRow++) {
                for (let tileCol = 0; tileCol < dimensionSize; tileCol++) {
                    if (!game[row][col][tileRow][tileCol]) {
                        continue;
                    }
                    let node = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    node.setAttribute("width", "1");
                    node.setAttribute("height", "1");
                    node.setAttribute("x", tileCol);
                    node.setAttribute("y", tileRow);
                    node.style.fill = "#666";
                    node.style.strokeWidth = 0;
                    node.style.shapeRendering = "optimizeSpeed";
                    svg.appendChild(node);
                }
            }
        }
    }
}

function clickedPreview(row, col) {
    //let board = parseBoardString("BwACAA4APgA4BVUO7hVUO7nd3f/z/+f/3////4");
    //let board = parseBoardString("DfAeZBj5cWPHZ4NOA/gFZAeYH3D0B+we2Hwf6A");
    //let board = parseBoardString("A+AIfAHWAMcBw+eMexIGLwh7+eGeZhhIMJCQkA");

    document.body.innerHTML = "";
    gameState = getDefaultGameState();
    loadNumberStates(game[row][col]);
    loadGame((finished) => {
        document.body.innerHTML = "";
        loadOverview();
    });
}

function parseGameString(data) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

    let index = data.indexOf(';');
    gameCols = parseInt(data.substring(0, index));
    gameRows = parseInt(data.substring(index + 1, data.indexOf(';', index + 1)));
    index = data.indexOf(';', index + 1) + 1;

    let fields = [];
    for (let i = index; i < data.length; i++) {
        let val = chars.indexOf(data[i]);
        fields.push((val & 32) > 0);
        fields.push((val & 16) > 0);
        fields.push((val & 8) > 0);
        fields.push((val & 4) > 0);
        fields.push((val & 2) > 0);
        fields.push((val & 1) > 0);
    }

    if (fields.length < gameCols * gameRows * dimensionSize * dimensionSize) {
        throw "Game string too short";
    }

    let rowSize = gameCols * dimensionSize;
    let game = [];
    for (let row = 0; row < gameRows; row++) {
        game.push([]);
        for (let col = 0; col < gameCols; col++) {

            let offset = row * dimensionSize * rowSize + col * dimensionSize;
            let board = [];
            for (let i = 0; i < dimensionSize; i++) {
                board.push([]);
                for (let j = 0; j < dimensionSize; j++) {
                    board[i].push(fields[offset + i * rowSize + j]);
                }
            }
            game[row].push(board);
        }
    }
    return game;
}
